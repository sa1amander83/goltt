{% extends 'base/base.html' %}
{% load static %}
{% block title %}Event Calendar{% endblock title %}

{% block extracss %}
    <link href="{% static 'calender/main.css' %}" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
 <link href="{% static 'calender/main.css' %}" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.css" rel="stylesheet">

{% endblock extracss %}

{% block breadcrumb %}
    <div>
        <h1><i class="fa fa-calendar"></i> Календарь</h1>
        <p>Расписание</p>
    </div>
    <ul class="app-breadcrumb breadcrumb">
        <li class="breadcrumb-item"><i class="fa fa-home fa-lg"></i></li>
        <li class="breadcrumb-item"><a>Календарь </a></li>
    </ul>
{% endblock breadcrumb %}

{% block content %}
    <div id="app">
        <div class="row">
            <div class="col-md-12">
                <div class="tile row">
                    <div class="col-md-3">
                        <div id="external-events">
                            <h4 class="mb-4">Сейчас идет</h4>
                            {% for event in current_bookings %}
                                <div class="fc-event">
                                    <h3>{{ event.title }}</h3>
                                    <p>{{ event.description }}</p>
                                    <p>{{ event.table }}</p>
                                    <p>Начало: {{ event.start_time }}</p>
                                    <p>Конец: {{ event.end_time }}</p>
                                </div>
                            {% empty %}
                                <p> Не найдено бронирований</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div id="calendar"></div>
                    </div>

                    <!-- Modal for Booking -->
                    <div class="modal fade show" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header bg-primary">
                                    <h5 class="modal-title text-white" id="exampleModalLongTitle">Забронировать стол</h5>
                                    <button id="modalClose1" type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <form @submit.prevent="submitBooking">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="form-group">
                                            <label for="recipient-name" class="col-form-label"></label>
                                            {{ form.title }}
                                        </div>
                                        <div class="form-group">
                                            {{ form.description }}
                                        </div>
                                        <div class="form-group">
                                            <label for="message-text" class="col-form-label">Начало брони:</label>
                                            <input type="text" v-model="startTime" id="start_time" ref="startTimePicker" class="form-control" />
                                        </div>
                                        <div class="form-group">
                                            <label for="message-text" class="col-form-label">Конец брони:</label>
                                            <input type="text" v-model="endTime" id="end_time" ref="endTimePicker" class="form-control" />
                                        </div>
                                        <div class="form-group">
                                            <label for="id_table">Выберите стол:</label>
                                            <select name="table" id="id_table" class="form-control" v-model="selectedTable">
                                                {% for table in tables %}
                                                    <option value="{{ table.id }}" :data-price-hour="{{ table.price_per_hour }}" :data-price-half-hour="{{ table.price_per_half_hour }}">
                                                        Стол {{ table.number }} ({{ table.table_description }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="d-flex justify-content-between important">
                                            <div class="form-group">
                                                <label for="total-cost-display" class="col-form-label">Итоговая сумма: <span id="total-cost-display">{{ totalCost }}</span></label>
                                            </div>
                                            <input type="hidden" name="total_cost" :value="totalCost" id="total-cost">
                                            <div class="form-group">
                                                <label for="total-time-display" class="col-form-label">Всего часов: <span id="total-time-display">{{ totalTime }}</span></label>
                                            </div>
                                            <input type="hidden" name="total_time" :value="totalTime" id="total-time">
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button id="modalClose2" type="button" class="btn btn-danger">Закрыть</button>
                                        <button type="submit" class="btn btn-primary">Забронировать</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascript %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
     <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.js"></script>
  <script>
new Vue({
    el: '#app',
    data: {
        events: [
            {% for event in current_bookings %}
            {
                title: '{{ event.title }}',
                start: '{{ event.start_time }}',
                end: '{{ event.end_time }}',
                description: '{{ event.description }}',
                table: '{{ event.table }}'
            },
            {% endfor %}
        ],
        startDate: '',
        endDate: ''
    },
    mounted() {
        this.initializeCalendar();
        this.initializeFlatpickr();
    },
    methods: {
        initializeCalendar() {
            $('#calendar').fullCalendar({
                events: this.events,
                eventClick: this.handleEventClick,
                locale: 'ru',
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                dayClick: this.handleDayClick
            });
        },
        initializeFlatpickr() {
            flatpickr("#id_start_time", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true,
                minuteIncrement: 30,
                locale: "ru",
                onChange: this.calculateTimeAndCost
            });

            flatpickr("#id_end_time", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true,
                minuteIncrement: 30,
                locale: "ru",
                onChange: this.calculateTimeAndCost
            });
        },
        handleEventClick(event) {
            alert(`Событие: ${event.title}\nОписание: ${event.description}\nНачало: ${event.start}\nКонец: ${event.end}`);
        },
        handleDayClick(date) {
            console.log('Выбрана дата: ', date.format());
            this.openModal(date.format());  // Открыть модальное окно
        },
        openModal(date) {
            $('#eventModal').modal('show');
            $('#id_start_time').val(date);
            $('#id_end_time').val(date);
        },
        calculateTimeAndCost() {
            const startTime = document.querySelector("#id_start_time").value;
            const endTime = document.querySelector("#id_end_time").value;

            if (!startTime || !endTime) return;

            const diffMs = new Date(endTime) - new Date(startTime);
            const diffHours = diffMs / (1000 * 60 * 60);
            const roundedHours = Math.round(diffHours * 2) / 2;

            const tableSelect = document.getElementById('id_table');
            const selectedOption = tableSelect.options[tableSelect.selectedIndex];
            const pricePerHour = parseFloat(selectedOption.getAttribute('data-price-hour')) || 0;
            const pricePerHalfHour = parseFloat(selectedOption.getAttribute('data-price-half-hour')) || 0;

            const totalCost = Math.floor(roundedHours) * pricePerHour + (roundedHours % 1 !== 0 ? pricePerHalfHour : 0);

            document.getElementById('total-time-display').textContent = `${roundedHours}`;
            document.getElementById('total-cost-display').textContent = `${totalCost.toFixed(2)} руб.`;

            document.getElementById('total-time').value = roundedHours;
            document.getElementById('total-cost').value = parseInt(totalCost);
        }
    }
});
</script>
{% endblock javascript %}
