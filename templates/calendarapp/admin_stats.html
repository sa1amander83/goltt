{% extends 'base/base.html' %}
{% load static %}

{% block title %}События{% endblock title %}
{% block extracss %}
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet"/>
{% endblock extracss %}

{% block breadcrumb %}
    <ul class="app-breadcrumb breadcrumb">
        <li class="breadcrumb-item"><i class="fa fa-home fa-lg"></i></li>
        <li class="breadcrumb-item"><a>Отчет по столам</a></li>
    </ul>
{% endblock breadcrumb %}

{% block content %}
    <div class="table-links mb-4">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-table-id="" onclick="loadTableStatistics()">Все</a>
            </li>
            {% for table in table_stats %}
                <li class="nav-item">
                    <a class="nav-link" href="#" data-table-id="{{ table.table_number }}" onclick="loadTableStatistics({{ table.table_number }})">
                        Стол {{ table.table_number }}
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <div id="tableStatisticsContainer">
        <!-- Здесь будет отображаться статистика -->
    </div>

    <div class="calendar-container mb-4">
        <h3>Выберите дату:</h3>
        <input type="date" id="statisticsDatePicker" class="form-control">
    </div>

    <table id="table-table">
        <thead>
        <tr>
            <th>Стол</th>
            <th>Количество бронирований за день</th>
            <th>Количество бронирований за месяц</th>
            <th>Дневной доход</th>
            <th>Месячный доход</th>
        </tr>
        </thead>
        <tbody>
        {% for stat in table_stats %}
            <tr>
                <td>{{ stat.table_number }}</td>
                <td>{{ stat.total_bookings_today }}</td>
                <td>{{ stat.total_bookings_month }}</td>
                <td>{{ stat.daily_income }} ₽</td>
                <td>{{ stat.monthly_income }} ₽</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h2>Итого за сегодня: {{ total_daily_income }} ₽</h2>
    <h2>Итого за месяц: {{ total_monthly_income }} ₽</h2>

    <canvas id="bookingChart" width="400" height="200"></canvas>
{% endblock content %}

{% block extrascripts %}
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const datePicker = document.getElementById('statisticsDatePicker');
            if (datePicker) {
                datePicker.value = new Date().toISOString().split('T')[0];
                datePicker.addEventListener('change', () => loadTableStatistics());
            }

            if (document.getElementById("table-table") && typeof simpleDatatables !== 'undefined') {
                new simpleDatatables.DataTable("#table-table", {
                    searchable: false,
                    perPageSelect: false
                });
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                    const tableId = this.getAttribute('data-table-id');
                    loadTableStatistics(tableId);
                });
            });

            loadTableStatistics();
        });

        function loadTableStatistics(tableId = '') {
            const selectedDate = document.getElementById('statisticsDatePicker').value;

            fetch(`/get_table_statistics/?table_id=${tableId}&date=${selectedDate}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети или сервера');
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('tableStatisticsContainer');
                    if (container) {
                        if (Array.isArray(data)) {
                            container.innerHTML = '<h4>Общая статистика</h4>';
                            data.forEach(stat => {
                                container.innerHTML += `
                                    <p><strong>Стол ${stat.table_number}</strong></p>
                                    <p>Количество бронирований: ${stat.total_events}</p>
                                    <p>Общий доход: ${stat.total_income} ₽</p>
                                    <p>Среднее время бронирования: ${stat.average_booking_time} часов</p>
                                    <p>Общее время бронирования: ${stat.sum_time} часов</p>
                                    <hr>
                                `;
                            });
                        } else {
                            container.innerHTML = `
                                <h4>Статистика ${data.table_number}</h4>
                                <p>Дата: ${selectedDate}</p>
                                <p>Количество бронирований: ${data.total_events}</p>
                                <p>Общий доход: ${data.total_income} ₽</p>
                                <p>Среднее время бронирования: ${data.average_booking_time} часов</p>
                                <p>Общее время бронирования: ${data.sum_time} часов</p>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке статистики:', error);
                    document.getElementById('tableStatisticsContainer').innerHTML =
                        `<p class="text-danger">Ошибка: ${error.message}</p>`;
                });
        }
    </script>
{% endblock %}